name: Sync OAuth Secrets to SSM

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to sync OAuth secrets for (dev, staging, prod)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  sync-oauth-secrets:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage == 'prod' && 'production' || (github.event.inputs.stage == 'staging' && 'staging' || 'development') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set stage-specific variables
        id: env
        run: |
          STAGE="${{ github.event.inputs.stage }}"
          echo "stage=${STAGE}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::570331155915:role/GitHubActions-Deploy-Dev
          aws-region: us-west-2

      - name: Build and Upload OAuth Platform Credentials
        env:
          STAGE: ${{ steps.env.outputs.stage }}

          # Keap OAuth
          DEV_OAUTH_KEAP_CLIENT_ID: ${{ secrets.DEV_PLATFORM_OAUTH_KEAP_CLIENT_ID }}
          DEV_OAUTH_KEAP_CLIENT_SECRET: ${{ secrets.DEV_PLATFORM_OAUTH_KEAP_CLIENT_SECRET }}
          STAGING_OAUTH_KEAP_CLIENT_ID: ${{ secrets.STAGING_PLATFORM_OAUTH_KEAP_CLIENT_ID }}
          STAGING_OAUTH_KEAP_CLIENT_SECRET: ${{ secrets.STAGING_PLATFORM_OAUTH_KEAP_CLIENT_SECRET }}
          PROD_OAUTH_KEAP_CLIENT_ID: ${{ secrets.PROD_PLATFORM_OAUTH_KEAP_CLIENT_ID }}
          PROD_OAUTH_KEAP_CLIENT_SECRET: ${{ secrets.PROD_PLATFORM_OAUTH_KEAP_CLIENT_SECRET }}

          # GoHighLevel OAuth
          DEV_OAUTH_GOHIGHLEVEL_CLIENT_ID: ${{ secrets.DEV_PLATFORM_OAUTH_GOHIGHLEVEL_CLIENT_ID }}
          DEV_OAUTH_GOHIGHLEVEL_CLIENT_SECRET: ${{ secrets.DEV_PLATFORM_OAUTH_GOHIGHLEVEL_CLIENT_SECRET }}
          STAGING_OAUTH_GOHIGHLEVEL_CLIENT_ID: ${{ secrets.STAGING_PLATFORM_OAUTH_GOHIGHLEVEL_CLIENT_ID }}
          STAGING_OAUTH_GOHIGHLEVEL_CLIENT_SECRET: ${{ secrets.STAGING_PLATFORM_OAUTH_GOHIGHLEVEL_CLIENT_SECRET }}
          PROD_OAUTH_GOHIGHLEVEL_CLIENT_ID: ${{ secrets.PROD_PLATFORM_OAUTH_GOHIGHLEVEL_CLIENT_ID }}
          PROD_OAUTH_GOHIGHLEVEL_CLIENT_SECRET: ${{ secrets.PROD_PLATFORM_OAUTH_GOHIGHLEVEL_CLIENT_SECRET }}

          # HubSpot OAuth
          DEV_OAUTH_HUBSPOT_CLIENT_ID: ${{ secrets.DEV_PLATFORM_OAUTH_HUBSPOT_CLIENT_ID }}
          DEV_OAUTH_HUBSPOT_CLIENT_SECRET: ${{ secrets.DEV_PLATFORM_OAUTH_HUBSPOT_CLIENT_SECRET }}
          STAGING_OAUTH_HUBSPOT_CLIENT_ID: ${{ secrets.STAGING_PLATFORM_OAUTH_HUBSPOT_CLIENT_ID }}
          STAGING_OAUTH_HUBSPOT_CLIENT_SECRET: ${{ secrets.STAGING_PLATFORM_OAUTH_HUBSPOT_CLIENT_SECRET }}
          PROD_OAUTH_HUBSPOT_CLIENT_ID: ${{ secrets.PROD_PLATFORM_OAUTH_HUBSPOT_CLIENT_ID }}
          PROD_OAUTH_HUBSPOT_CLIENT_SECRET: ${{ secrets.PROD_PLATFORM_OAUTH_HUBSPOT_CLIENT_SECRET }}

          # Google Sheets OAuth
          DEV_OAUTH_GOOGLE_SHEETS_CLIENT_ID: ${{ secrets.DEV_PLATFORM_OAUTH_GOOGLE_SHEETS_CLIENT_ID }}
          DEV_OAUTH_GOOGLE_SHEETS_CLIENT_SECRET: ${{ secrets.DEV_PLATFORM_OAUTH_GOOGLE_SHEETS_CLIENT_SECRET }}
          STAGING_OAUTH_GOOGLE_SHEETS_CLIENT_ID: ${{ secrets.STAGING_PLATFORM_OAUTH_GOOGLE_SHEETS_CLIENT_ID }}
          STAGING_OAUTH_GOOGLE_SHEETS_CLIENT_SECRET: ${{ secrets.STAGING_PLATFORM_OAUTH_GOOGLE_SHEETS_CLIENT_SECRET }}
          PROD_OAUTH_GOOGLE_SHEETS_CLIENT_ID: ${{ secrets.PROD_PLATFORM_OAUTH_GOOGLE_SHEETS_CLIENT_ID }}
          PROD_OAUTH_GOOGLE_SHEETS_CLIENT_SECRET: ${{ secrets.PROD_PLATFORM_OAUTH_GOOGLE_SHEETS_CLIENT_SECRET }}

          # Zoom OAuth
          DEV_OAUTH_ZOOM_CLIENT_ID: ${{ secrets.DEV_PLATFORM_OAUTH_ZOOM_CLIENT_ID }}
          DEV_OAUTH_ZOOM_CLIENT_SECRET: ${{ secrets.DEV_PLATFORM_OAUTH_ZOOM_CLIENT_SECRET }}
          STAGING_OAUTH_ZOOM_CLIENT_ID: ${{ secrets.STAGING_PLATFORM_OAUTH_ZOOM_CLIENT_ID }}
          STAGING_OAUTH_ZOOM_CLIENT_SECRET: ${{ secrets.STAGING_PLATFORM_OAUTH_ZOOM_CLIENT_SECRET }}
          PROD_OAUTH_ZOOM_CLIENT_ID: ${{ secrets.PROD_PLATFORM_OAUTH_ZOOM_CLIENT_ID }}
          PROD_OAUTH_ZOOM_CLIENT_SECRET: ${{ secrets.PROD_PLATFORM_OAUTH_ZOOM_CLIENT_SECRET }}

          # Dropbox OAuth
          DEV_OAUTH_DROPBOX_CLIENT_ID: ${{ secrets.DEV_PLATFORM_OAUTH_DROPBOX_CLIENT_ID }}
          DEV_OAUTH_DROPBOX_CLIENT_SECRET: ${{ secrets.DEV_PLATFORM_OAUTH_DROPBOX_CLIENT_SECRET }}
          STAGING_OAUTH_DROPBOX_CLIENT_ID: ${{ secrets.STAGING_PLATFORM_OAUTH_DROPBOX_CLIENT_ID }}
          STAGING_OAUTH_DROPBOX_CLIENT_SECRET: ${{ secrets.STAGING_PLATFORM_OAUTH_DROPBOX_CLIENT_SECRET }}
          PROD_OAUTH_DROPBOX_CLIENT_ID: ${{ secrets.PROD_PLATFORM_OAUTH_DROPBOX_CLIENT_ID }}
          PROD_OAUTH_DROPBOX_CLIENT_SECRET: ${{ secrets.PROD_PLATFORM_OAUTH_DROPBOX_CLIENT_SECRET }}

          # Box OAuth
          DEV_OAUTH_BOX_CLIENT_ID: ${{ secrets.DEV_PLATFORM_OAUTH_BOX_CLIENT_ID }}
          DEV_OAUTH_BOX_CLIENT_SECRET: ${{ secrets.DEV_PLATFORM_OAUTH_BOX_CLIENT_SECRET }}
          STAGING_OAUTH_BOX_CLIENT_ID: ${{ secrets.STAGING_PLATFORM_OAUTH_BOX_CLIENT_ID }}
          STAGING_OAUTH_BOX_CLIENT_SECRET: ${{ secrets.STAGING_PLATFORM_OAUTH_BOX_CLIENT_SECRET }}
          PROD_OAUTH_BOX_CLIENT_ID: ${{ secrets.PROD_PLATFORM_OAUTH_BOX_CLIENT_ID }}
          PROD_OAUTH_BOX_CLIENT_SECRET: ${{ secrets.PROD_PLATFORM_OAUTH_BOX_CLIENT_SECRET }}

          # GoToWebinar OAuth
          DEV_OAUTH_GOTOWEBINAR_CLIENT_ID: ${{ secrets.DEV_PLATFORM_OAUTH_GOTOWEBINAR_CLIENT_ID }}
          DEV_OAUTH_GOTOWEBINAR_CLIENT_SECRET: ${{ secrets.DEV_PLATFORM_OAUTH_GOTOWEBINAR_CLIENT_SECRET }}
          STAGING_OAUTH_GOTOWEBINAR_CLIENT_ID: ${{ secrets.STAGING_PLATFORM_OAUTH_GOTOWEBINAR_CLIENT_ID }}
          STAGING_OAUTH_GOTOWEBINAR_CLIENT_SECRET: ${{ secrets.STAGING_PLATFORM_OAUTH_GOTOWEBINAR_CLIENT_SECRET }}
          PROD_OAUTH_GOTOWEBINAR_CLIENT_ID: ${{ secrets.PROD_PLATFORM_OAUTH_GOTOWEBINAR_CLIENT_ID }}
          PROD_OAUTH_GOTOWEBINAR_CLIENT_SECRET: ${{ secrets.PROD_PLATFORM_OAUTH_GOTOWEBINAR_CLIENT_SECRET }}

        run: |
          chmod +x backend/golang/scripts/build-oauth-secrets.sh
          ./backend/golang/scripts/build-oauth-secrets.sh

      - name: Verify OAuth Secrets Upload
        env:
          STAGE: ${{ steps.env.outputs.stage }}
        run: |
          echo "Verifying OAuth credentials upload..."

          aws ssm get-parameter \
            --name "/myfusionhelper/${STAGE}/platforms/oauth/credentials" \
            --with-decryption \
            --query 'Parameter.Value' \
            --output text | jq 'keys'

          echo "OAuth secrets verification complete."
