name: Setup Stripe Product with Plans

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to create product for (dev, staging, main)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - main
      product_name:
        description: 'Stripe Product name'
        required: true
        default: 'MyFusion Helper'
      existing_product_id:
        description: 'Existing Stripe Product ID (skip product creation)'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  setup-stripe:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage == 'main' && 'production' || (github.event.inputs.stage == 'staging' && 'staging' || 'development') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Stripe Key
        id: stripe-key
        run: |
          STAGE="${{ github.event.inputs.stage }}"
          STAGE_UPPER=$(echo "$STAGE" | tr '[:lower:]' '[:upper:]')
          echo "stage_upper=${STAGE_UPPER}" >> $GITHUB_OUTPUT

      - name: Create Stripe Product and Prices
        env:
          STRIPE_SECRET_KEY: ${{ github.event.inputs.stage == 'dev' && secrets.DEV_INTERNAL_STRIPE_SECRET_KEY || (github.event.inputs.stage == 'staging' && secrets.STAGING_INTERNAL_STRIPE_SECRET_KEY || secrets.MAIN_INTERNAL_STRIPE_SECRET_KEY) }}
          PRODUCT_NAME: ${{ github.event.inputs.product_name }}
          EXISTING_PRODUCT_ID: ${{ github.event.inputs.existing_product_id }}
          STAGE_UPPER: ${{ steps.stripe-key.outputs.stage_upper }}
        run: |
          set -eo pipefail

          if [ -z "$STRIPE_SECRET_KEY" ]; then
            echo "ERROR: No Stripe secret key found for stage ${{ github.event.inputs.stage }}"
            exit 1
          fi

          echo "Stripe key loaded (${STRIPE_SECRET_KEY:0:7}...)"

          # 1. Create or reuse the Product
          if [ -n "$EXISTING_PRODUCT_ID" ]; then
            PRODUCT_ID="$EXISTING_PRODUCT_ID"
            echo "Using existing product: $PRODUCT_ID"
          else
            echo "Creating Stripe Product: $PRODUCT_NAME..."
            PRODUCT_RESPONSE=$(curl -s -X POST https://api.stripe.com/v1/products \
              -u "${STRIPE_SECRET_KEY}:" \
              -d "name=${PRODUCT_NAME}" \
              -d "description=MyFusion Helper CRM automation subscription plans" \
              -d "metadata[app]=myfusionhelper" \
              -d "metadata[managed_by]=github-actions")

            PRODUCT_ID=$(echo "$PRODUCT_RESPONSE" | jq -r '.id // empty')
            if [ -z "$PRODUCT_ID" ]; then
              echo "ERROR: Failed to create product"
              echo "$PRODUCT_RESPONSE" | jq '.'
              exit 1
            fi
            echo "Product created: $PRODUCT_ID"
          fi

          # 2. Create 6 Prices under the Product

          echo "Creating Start Monthly price (3900 cents/mo)..."
          START_MONTHLY=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=3900" \
            -d "currency=usd" \
            -d "recurring[interval]=month" \
            -d "nickname=Start Monthly" \
            -d "metadata[plan]=start" \
            -d "metadata[period]=monthly" \
            | jq -r '.id')
          echo "  Start Monthly: $START_MONTHLY"

          echo "Creating Start Annual price (39600 cents/yr)..."
          START_ANNUAL=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=39600" \
            -d "currency=usd" \
            -d "recurring[interval]=year" \
            -d "nickname=Start Annual" \
            -d "metadata[plan]=start" \
            -d "metadata[period]=annual" \
            | jq -r '.id')
          echo "  Start Annual: $START_ANNUAL"

          echo "Creating Grow Monthly price (5900 cents/mo)..."
          GROW_MONTHLY=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=5900" \
            -d "currency=usd" \
            -d "recurring[interval]=month" \
            -d "nickname=Grow Monthly" \
            -d "metadata[plan]=grow" \
            -d "metadata[period]=monthly" \
            | jq -r '.id')
          echo "  Grow Monthly: $GROW_MONTHLY"

          echo "Creating Grow Annual price (58800 cents/yr)..."
          GROW_ANNUAL=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=58800" \
            -d "currency=usd" \
            -d "recurring[interval]=year" \
            -d "nickname=Grow Annual" \
            -d "metadata[plan]=grow" \
            -d "metadata[period]=annual" \
            | jq -r '.id')
          echo "  Grow Annual: $GROW_ANNUAL"

          echo "Creating Deliver Monthly price (7900 cents/mo)..."
          DELIVER_MONTHLY=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=7900" \
            -d "currency=usd" \
            -d "recurring[interval]=month" \
            -d "nickname=Deliver Monthly" \
            -d "metadata[plan]=deliver" \
            -d "metadata[period]=monthly" \
            | jq -r '.id')
          echo "  Deliver Monthly: $DELIVER_MONTHLY"

          echo "Creating Deliver Annual price (79200 cents/yr)..."
          DELIVER_ANNUAL=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=79200" \
            -d "currency=usd" \
            -d "recurring[interval]=year" \
            -d "nickname=Deliver Annual" \
            -d "metadata[plan]=deliver" \
            -d "metadata[period]=annual" \
            | jq -r '.id')
          echo "  Deliver Annual: $DELIVER_ANNUAL"

          # 3. Summary
          echo ""
          echo "============================================"
          echo "Stripe Product Setup Complete!"
          echo "============================================"
          echo "Product ID: $PRODUCT_ID"
          echo ""
          echo "Price IDs:"
          echo "  STRIPE_PRICE_START:          $START_MONTHLY"
          echo "  STRIPE_PRICE_START_ANNUAL:   $START_ANNUAL"
          echo "  STRIPE_PRICE_GROW:           $GROW_MONTHLY"
          echo "  STRIPE_PRICE_GROW_ANNUAL:    $GROW_ANNUAL"
          echo "  STRIPE_PRICE_DELIVER:        $DELIVER_MONTHLY"
          echo "  STRIPE_PRICE_DELIVER_ANNUAL: $DELIVER_ANNUAL"
          echo ""
          echo "GitHub Secret update commands:"
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_START -b $START_MONTHLY"
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_START_ANNUAL -b $START_ANNUAL"
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_GROW -b $GROW_MONTHLY"
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_GROW_ANNUAL -b $GROW_ANNUAL"
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_DELIVER -b $DELIVER_MONTHLY"
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_DELIVER_ANNUAL -b $DELIVER_ANNUAL"
          echo ""
          echo "Then run: Sync Internal Secrets to SSM (stage: ${{ github.event.inputs.stage }})"
