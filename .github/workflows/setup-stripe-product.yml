name: Setup Stripe Product with Plans

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to create product for (dev, staging, main)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - main
      product_name:
        description: 'Stripe Product name'
        required: true
        default: 'MyFusion Helper'
      dry_run:
        description: 'Dry run (show what would be created without creating)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  setup-stripe:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage == 'main' && 'production' || (github.event.inputs.stage == 'staging' && 'staging' || 'development') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Stripe Key
        id: stripe-key
        run: |
          STAGE="${{ github.event.inputs.stage }}"
          STAGE_UPPER=$(echo "$STAGE" | tr '[:lower:]' '[:upper:]')
          echo "stage_upper=${STAGE_UPPER}" >> $GITHUB_OUTPUT

      - name: Create Stripe Product and Prices
        env:
          STRIPE_SECRET_KEY: ${{ github.event.inputs.stage == 'dev' && secrets.DEV_INTERNAL_STRIPE_SECRET_KEY || (github.event.inputs.stage == 'staging' && secrets.STAGING_INTERNAL_STRIPE_SECRET_KEY || secrets.MAIN_INTERNAL_STRIPE_SECRET_KEY) }}
          PRODUCT_NAME: ${{ github.event.inputs.product_name }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          set -euo pipefail

          if [ -z "$STRIPE_SECRET_KEY" ]; then
            echo "ERROR: No Stripe secret key found for stage ${{ github.event.inputs.stage }}"
            exit 1
          fi

          echo "Stripe key loaded (${STRIPE_SECRET_KEY:0:7}...)"

          if [ "$DRY_RUN" = "true" ]; then
            echo "=== DRY RUN MODE ==="
            echo "Would create product: $PRODUCT_NAME"
            echo "Would create 6 prices:"
            echo "  - Start Monthly: $39/mo recurring"
            echo "  - Start Annual: $396/yr recurring ($33/mo)"
            echo "  - Grow Monthly: $59/mo recurring"
            echo "  - Grow Annual: $588/yr recurring ($49/mo)"
            echo "  - Deliver Monthly: $79/mo recurring"
            echo "  - Deliver Annual: $792/yr recurring ($66/mo)"
            exit 0
          fi

          # 1. Create the Product
          echo "Creating Stripe Product: $PRODUCT_NAME..."
          PRODUCT_RESPONSE=$(curl -s -X POST https://api.stripe.com/v1/products \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "name=${PRODUCT_NAME}" \
            -d "description=MyFusion Helper CRM automation subscription plans" \
            -d "metadata[app]=myfusionhelper" \
            -d "metadata[managed_by]=github-actions")

          PRODUCT_ID=$(echo "$PRODUCT_RESPONSE" | jq -r '.id // empty')
          if [ -z "$PRODUCT_ID" ]; then
            echo "ERROR: Failed to create product"
            echo "$PRODUCT_RESPONSE" | jq '.'
            exit 1
          fi
          echo "Product created: $PRODUCT_ID"

          # 2. Create 6 Prices under the Product

          # Start Monthly - $39/mo
          echo "Creating Start Monthly price ($39/mo)..."
          START_MONTHLY=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=3900" \
            -d "currency=usd" \
            -d "recurring[interval]=month" \
            -d "nickname=Start Monthly" \
            -d "metadata[plan]=start" \
            -d "metadata[period]=monthly" \
            | jq -r '.id')
          echo "  Start Monthly: $START_MONTHLY"

          # Start Annual - $396/yr
          echo "Creating Start Annual price ($396/yr)..."
          START_ANNUAL=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=39600" \
            -d "currency=usd" \
            -d "recurring[interval]=year" \
            -d "nickname=Start Annual" \
            -d "metadata[plan]=start" \
            -d "metadata[period]=annual" \
            | jq -r '.id')
          echo "  Start Annual: $START_ANNUAL"

          # Grow Monthly - $59/mo
          echo "Creating Grow Monthly price ($59/mo)..."
          GROW_MONTHLY=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=5900" \
            -d "currency=usd" \
            -d "recurring[interval]=month" \
            -d "nickname=Grow Monthly" \
            -d "metadata[plan]=grow" \
            -d "metadata[period]=monthly" \
            | jq -r '.id')
          echo "  Grow Monthly: $GROW_MONTHLY"

          # Grow Annual - $588/yr
          echo "Creating Grow Annual price ($588/yr)..."
          GROW_ANNUAL=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=58800" \
            -d "currency=usd" \
            -d "recurring[interval]=year" \
            -d "nickname=Grow Annual" \
            -d "metadata[plan]=grow" \
            -d "metadata[period]=annual" \
            | jq -r '.id')
          echo "  Grow Annual: $GROW_ANNUAL"

          # Deliver Monthly - $79/mo
          echo "Creating Deliver Monthly price ($79/mo)..."
          DELIVER_MONTHLY=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=7900" \
            -d "currency=usd" \
            -d "recurring[interval]=month" \
            -d "nickname=Deliver Monthly" \
            -d "metadata[plan]=deliver" \
            -d "metadata[period]=monthly" \
            | jq -r '.id')
          echo "  Deliver Monthly: $DELIVER_MONTHLY"

          # Deliver Annual - $792/yr
          echo "Creating Deliver Annual price ($792/yr)..."
          DELIVER_ANNUAL=$(curl -s -X POST https://api.stripe.com/v1/prices \
            -u "${STRIPE_SECRET_KEY}:" \
            -d "product=${PRODUCT_ID}" \
            -d "unit_amount=79200" \
            -d "currency=usd" \
            -d "recurring[interval]=year" \
            -d "nickname=Deliver Annual" \
            -d "metadata[plan]=deliver" \
            -d "metadata[period]=annual" \
            | jq -r '.id')
          echo "  Deliver Annual: $DELIVER_ANNUAL"

          # 3. Summary
          echo ""
          echo "============================================"
          echo "Stripe Product Setup Complete!"
          echo "============================================"
          echo "Product ID: $PRODUCT_ID"
          echo ""
          echo "Price IDs (update these in GitHub Secrets):"
          echo "  STRIPE_PRICE_START:          $START_MONTHLY"
          echo "  STRIPE_PRICE_START_ANNUAL:   $START_ANNUAL"
          echo "  STRIPE_PRICE_GROW:           $GROW_MONTHLY"
          echo "  STRIPE_PRICE_GROW_ANNUAL:    $GROW_ANNUAL"
          echo "  STRIPE_PRICE_DELIVER:        $DELIVER_MONTHLY"
          echo "  STRIPE_PRICE_DELIVER_ANNUAL: $DELIVER_ANNUAL"
          echo ""
          echo "To update GitHub Secrets, run:"
          STAGE_UPPER="${{ steps.stripe-key.outputs.stage_upper }}"
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_START -b \"$START_MONTHLY\""
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_START_ANNUAL -b \"$START_ANNUAL\""
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_GROW -b \"$GROW_MONTHLY\""
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_GROW_ANNUAL -b \"$GROW_ANNUAL\""
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_DELIVER -b \"$DELIVER_MONTHLY\""
          echo "  gh secret set ${STAGE_UPPER}_INTERNAL_STRIPE_PRICE_DELIVER_ANNUAL -b \"$DELIVER_ANNUAL\""
          echo ""
          echo "Then run the 'Sync Internal Secrets to SSM' workflow for stage: ${{ github.event.inputs.stage }}"
