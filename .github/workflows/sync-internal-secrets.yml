name: Sync Internal Secrets to SSM

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to sync secrets for (dev, staging, prod)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  sync-internal-secrets:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage == 'prod' && 'production' || (github.event.inputs.stage == 'staging' && 'staging' || 'development') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set stage-specific variables
        id: env
        run: |
          STAGE="${{ github.event.inputs.stage }}"
          echo "stage=${STAGE}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::570331155915:role/GitHubActions-Deploy-Dev
          aws-region: us-west-2

      - name: Build and Upload Unified Internal Secrets
        env:
          STAGE: ${{ steps.env.outputs.stage }}

          # Stripe Secrets
          DEV_INTERNAL_STRIPE_SECRET_KEY: ${{ secrets.DEV_INTERNAL_STRIPE_SECRET_KEY }}
          DEV_INTERNAL_STRIPE_PUBLISHABLE_KEY: ${{ secrets.DEV_INTERNAL_STRIPE_PUBLISHABLE_KEY }}
          DEV_INTERNAL_STRIPE_WEBHOOK_SECRET: ${{ secrets.DEV_INTERNAL_STRIPE_WEBHOOK_SECRET }}
          STAGING_INTERNAL_STRIPE_SECRET_KEY: ${{ secrets.STAGING_INTERNAL_STRIPE_SECRET_KEY }}
          STAGING_INTERNAL_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STAGING_INTERNAL_STRIPE_PUBLISHABLE_KEY }}
          STAGING_INTERNAL_STRIPE_WEBHOOK_SECRET: ${{ secrets.STAGING_INTERNAL_STRIPE_WEBHOOK_SECRET }}
          PROD_INTERNAL_STRIPE_SECRET_KEY: ${{ secrets.PROD_INTERNAL_STRIPE_SECRET_KEY }}
          PROD_INTERNAL_STRIPE_PUBLISHABLE_KEY: ${{ secrets.PROD_INTERNAL_STRIPE_PUBLISHABLE_KEY }}
          PROD_INTERNAL_STRIPE_WEBHOOK_SECRET: ${{ secrets.PROD_INTERNAL_STRIPE_WEBHOOK_SECRET }}

          # Groq Secrets
          DEV_INTERNAL_GROQ_API_KEY: ${{ secrets.DEV_INTERNAL_GROQ_API_KEY }}
          STAGING_INTERNAL_GROQ_API_KEY: ${{ secrets.STAGING_INTERNAL_GROQ_API_KEY }}
          PROD_INTERNAL_GROQ_API_KEY: ${{ secrets.PROD_INTERNAL_GROQ_API_KEY }}

          # Twilio Secrets
          DEV_INTERNAL_TWILIO_ACCOUNT_SID: ${{ secrets.DEV_INTERNAL_TWILIO_ACCOUNT_SID }}
          DEV_INTERNAL_TWILIO_AUTH_TOKEN: ${{ secrets.DEV_INTERNAL_TWILIO_AUTH_TOKEN }}
          DEV_INTERNAL_TWILIO_FROM_NUMBER: ${{ secrets.DEV_INTERNAL_TWILIO_FROM_NUMBER }}
          DEV_INTERNAL_TWILIO_MESSAGING_SID: ${{ secrets.DEV_INTERNAL_TWILIO_MESSAGING_SID }}
          STAGING_INTERNAL_TWILIO_ACCOUNT_SID: ${{ secrets.STAGING_INTERNAL_TWILIO_ACCOUNT_SID }}
          STAGING_INTERNAL_TWILIO_AUTH_TOKEN: ${{ secrets.STAGING_INTERNAL_TWILIO_AUTH_TOKEN }}
          STAGING_INTERNAL_TWILIO_FROM_NUMBER: ${{ secrets.STAGING_INTERNAL_TWILIO_FROM_NUMBER }}
          STAGING_INTERNAL_TWILIO_MESSAGING_SID: ${{ secrets.STAGING_INTERNAL_TWILIO_MESSAGING_SID }}
          PROD_INTERNAL_TWILIO_ACCOUNT_SID: ${{ secrets.PROD_INTERNAL_TWILIO_ACCOUNT_SID }}
          PROD_INTERNAL_TWILIO_AUTH_TOKEN: ${{ secrets.PROD_INTERNAL_TWILIO_AUTH_TOKEN }}
          PROD_INTERNAL_TWILIO_FROM_NUMBER: ${{ secrets.PROD_INTERNAL_TWILIO_FROM_NUMBER }}
          PROD_INTERNAL_TWILIO_MESSAGING_SID: ${{ secrets.PROD_INTERNAL_TWILIO_MESSAGING_SID }}
        run: |
          chmod +x backend/golang/scripts/build-internal-secrets.sh
          ./backend/golang/scripts/build-internal-secrets.sh

      - name: Verify Secrets Upload
        env:
          STAGE: ${{ steps.env.outputs.stage }}
        run: |
          echo "✅ Verifying unified secrets upload..."

          # Check unified JSON exists
          aws ssm get-parameter \
            --name "/myfusionhelper/${STAGE}/secrets" \
            --with-decryption \
            --query 'Parameter.Value' \
            --output text > /tmp/unified-secrets.json

          echo "Unified secrets structure:"
          cat /tmp/unified-secrets.json | jq '.'

          # Verify key structure exists
          echo ""
          echo "✅ Verifying secrets structure..."

          if cat /tmp/unified-secrets.json | jq -e '.stripe' >/dev/null; then
            echo "✓ stripe section exists"
          else
            echo "✗ stripe section missing"
            exit 1
          fi

          if cat /tmp/unified-secrets.json | jq -e '.groq' >/dev/null; then
            echo "✓ groq section exists"
          else
            echo "✗ groq section missing"
            exit 1
          fi

          if cat /tmp/unified-secrets.json | jq -e '.twilio' >/dev/null; then
            echo "✓ twilio section exists"
          else
            echo "✗ twilio section missing"
            exit 1
          fi

          echo ""
          echo "✅ Verification complete."
