name: Sync Internal Secrets to SSM

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to sync secrets for (dev, staging, prod)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  sync-internal-secrets:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage == 'prod' && 'production' || (github.event.inputs.stage == 'staging' && 'staging' || 'development') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set stage-specific variables
        id: env
        run: |
          STAGE="${{ github.event.inputs.stage }}"
          echo "stage=${STAGE}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::570331155915:role/GitHubActions-Deploy-Dev
          aws-region: us-west-2

      - name: Build and Upload Stripe Secrets
        env:
          STAGE: ${{ steps.env.outputs.stage }}

          # Stripe Secrets
          DEV_INTERNAL_STRIPE_SECRET_KEY: ${{ secrets.DEV_INTERNAL_STRIPE_SECRET_KEY }}
          DEV_INTERNAL_STRIPE_PUBLISHABLE_KEY: ${{ secrets.DEV_INTERNAL_STRIPE_PUBLISHABLE_KEY }}
          DEV_INTERNAL_STRIPE_WEBHOOK_SECRET: ${{ secrets.DEV_INTERNAL_STRIPE_WEBHOOK_SECRET }}
          STAGING_INTERNAL_STRIPE_SECRET_KEY: ${{ secrets.STAGING_INTERNAL_STRIPE_SECRET_KEY }}
          STAGING_INTERNAL_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STAGING_INTERNAL_STRIPE_PUBLISHABLE_KEY }}
          STAGING_INTERNAL_STRIPE_WEBHOOK_SECRET: ${{ secrets.STAGING_INTERNAL_STRIPE_WEBHOOK_SECRET }}
          PROD_INTERNAL_STRIPE_SECRET_KEY: ${{ secrets.PROD_INTERNAL_STRIPE_SECRET_KEY }}
          PROD_INTERNAL_STRIPE_PUBLISHABLE_KEY: ${{ secrets.PROD_INTERNAL_STRIPE_PUBLISHABLE_KEY }}
          PROD_INTERNAL_STRIPE_WEBHOOK_SECRET: ${{ secrets.PROD_INTERNAL_STRIPE_WEBHOOK_SECRET }}
        run: |
          chmod +x backend/golang/scripts/build-internal-secrets.sh
          ./backend/golang/scripts/build-internal-secrets.sh

      - name: Verify Secrets Upload
        env:
          STAGE: ${{ steps.env.outputs.stage }}
        run: |
          echo "Verifying Stripe secrets upload..."

          PASS=true

          if aws ssm get-parameter --name "/${STAGE}/stripe/secret_key" --with-decryption &>/dev/null; then
            echo "  /${STAGE}/stripe/secret_key exists"
          else
            echo "  /${STAGE}/stripe/secret_key MISSING"
            PASS=false
          fi

          if aws ssm get-parameter --name "/${STAGE}/stripe/publishable_key" --with-decryption &>/dev/null; then
            echo "  /${STAGE}/stripe/publishable_key exists"
          else
            echo "  /${STAGE}/stripe/publishable_key MISSING"
            PASS=false
          fi

          if aws ssm get-parameter --name "/${STAGE}/stripe/webhook_secret" --with-decryption &>/dev/null; then
            echo "  /${STAGE}/stripe/webhook_secret exists"
          else
            echo "  /${STAGE}/stripe/webhook_secret MISSING (may be optional)"
          fi

          if [ "$PASS" = false ]; then
            echo ""
            echo "ERROR: Required secrets are missing!"
            exit 1
          fi

          echo ""
          echo "Verification complete."
