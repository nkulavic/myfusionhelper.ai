service: mfh-helpers

frameworkVersion: '4'

plugins:
  - serverless-go-plugin

custom:
  go:
    baseDir: ../../..
    supportedRuntimes: ["provided.al2023"]
    buildProvidedRuntimeAsBootstrap: true
    cmd: 'GOARCH=arm64 GOOS=linux go build -ldflags="-s -w"'

provider:
  name: aws
  runtime: provided.al2023
  architecture: arm64
  region: us-west-2
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 29
  tracing:
    lambda: true
    apiGateway: true
  httpApi:
    id: ${cf:mfh-api-gateway-${self:provider.stage}.HttpApiId}
  environment:
    SERVICE_VERSION: "2025.02.04.0001"
    STAGE: ${self:provider.stage}
    COGNITO_USER_POOL_ID: ${cf:mfh-infrastructure-cognito-${self:provider.stage}.CognitoUserPoolId}
    COGNITO_CLIENT_ID: ${cf:mfh-infrastructure-cognito-${self:provider.stage}.CognitoUserPoolClientId}
    COGNITO_CLIENT_SECRET: ""
    COGNITO_REGION: ${self:provider.region}
    COGNITO_JWKS_URI: ${cf:mfh-infrastructure-cognito-${self:provider.stage}.CognitoJwksUri}
    COGNITO_ISSUER: ${cf:mfh-infrastructure-cognito-${self:provider.stage}.CognitoIssuer}
    USERS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UsersTableName}
    ACCOUNTS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.AccountsTableName}
    USER_ACCOUNTS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UserAccountsTableName}
    HELPERS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.HelpersTableName}
    EXECUTIONS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.ExecutionsTableName}
    CONNECTIONS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.ConnectionsTableName}
    RATE_LIMITS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.RateLimitsTableName}
    SCHEDULER_FUNCTION_ARN: ${cf:mfh-scheduler-${self:provider.stage}.SchedulerFunctionArn}
    API_VERSION: v1
    API_REFERENCE: mfh-api
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:BatchGetItem
            - dynamodb:DescribeTable
          Resource:
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UsersTableArn}
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.AccountsTableArn}
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UserAccountsTableArn}
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.HelpersTableArn}
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.ExecutionsTableArn}
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.ConnectionsTableArn}
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UsersTableArn}/index/*"
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.AccountsTableArn}/index/*"
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UserAccountsTableArn}/index/*"
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.HelpersTableArn}/index/*"
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.ExecutionsTableArn}/index/*"
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.ConnectionsTableArn}/index/*"
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.RateLimitsTableArn}
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "arn:aws:logs:${self:provider.region}:*:*"
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: "*"
        - Effect: Allow
          Action:
            - events:PutRule
            - events:DeleteRule
            - events:PutTargets
            - events:RemoveTargets
            - events:DescribeRule
            - events:DisableRule
            - events:EnableRule
          Resource:
            - "arn:aws:events:${self:provider.region}:*:rule/mfh-${self:provider.stage}-helper-schedule-*"
        - Effect: Allow
          Action:
            - lambda:AddPermission
            - lambda:RemovePermission
          Resource:
            - ${cf:mfh-scheduler-${self:provider.stage}.SchedulerFunctionArn}

functions:
  helpers-list:
    handler: cmd/handlers/helpers/main.go
    description: "List helpers"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: helpers-list
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: helpers-list
      ENDPOINT_PATH: /helpers
    events:
      - httpApi:
          path: /helpers
          method: get
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  helpers-create:
    handler: cmd/handlers/helpers/main.go
    description: "Create helper"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: helpers-create
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: helpers-create
      ENDPOINT_PATH: /helpers
    events:
      - httpApi:
          path: /helpers
          method: post
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  helpers-get:
    handler: cmd/handlers/helpers/main.go
    description: "Get helper details"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: helpers-get
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: helpers-get
      ENDPOINT_PATH: /helpers/{helper_id}
    events:
      - httpApi:
          path: /helpers/{helper_id}
          method: get
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  helpers-update:
    handler: cmd/handlers/helpers/main.go
    description: "Update helper"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: helpers-update
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: helpers-update
      ENDPOINT_PATH: /helpers/{helper_id}
    events:
      - httpApi:
          path: /helpers/{helper_id}
          method: put
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  helpers-delete:
    handler: cmd/handlers/helpers/main.go
    description: "Delete helper"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: helpers-delete
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: helpers-delete
      ENDPOINT_PATH: /helpers/{helper_id}
    events:
      - httpApi:
          path: /helpers/{helper_id}
          method: delete
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  helpers-execute:
    handler: cmd/handlers/helpers/main.go
    description: "Execute helper"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: helpers-execute
    memorySize: 512
    timeout: 29
    environment:
      FUNCTION_NAME: helpers-execute
      ENDPOINT_PATH: /helpers/{helper_id}/execute
    events:
      - httpApi:
          path: /helpers/{helper_id}/execute
          method: post
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  # Public endpoints
  helpers-health:
    handler: cmd/handlers/helpers/main.go
    description: "Health check endpoint"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: helpers-health
    memorySize: 128
    timeout: 5
    environment:
      FUNCTION_NAME: helpers-health
      ENDPOINT_PATH: /helpers/health
    events:
      - httpApi:
          path: /helpers/health
          method: get

  # Helper types catalog
  helpers-types-list:
    handler: cmd/handlers/helpers/main.go
    description: "List all available helper type definitions"
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: helpers-types-list
      ENDPOINT_PATH: /helpers/types
    events:
      - httpApi:
          path: /helpers/types
          method: get
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  helpers-types-get:
    handler: cmd/handlers/helpers/main.go
    description: "Get a specific helper type definition"
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: helpers-types-get
      ENDPOINT_PATH: /helpers/types/{type}
    events:
      - httpApi:
          path: /helpers/types/{type}
          method: get
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  # Executions
  executions-list:
    handler: cmd/handlers/helpers/main.go
    description: "List helper executions"
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: executions-list
      ENDPOINT_PATH: /executions
    events:
      - httpApi:
          path: /executions
          method: get
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  executions-get:
    handler: cmd/handlers/helpers/main.go
    description: "Get execution details"
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: executions-get
      ENDPOINT_PATH: /executions/{execution_id}
    events:
      - httpApi:
          path: /executions/{execution_id}
          method: get
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  # API-key-authenticated execute endpoints
  helper-execute-header:
    handler: cmd/handlers/helpers/main.go
    description: "Execute helper via API key (header auth)"
    memorySize: 512
    timeout: 29
    environment:
      FUNCTION_NAME: helper-execute
      ENDPOINT_PATH: /helper/{identifier}/execute
    events:
      - httpApi:
          path: /helper/{identifier}/execute
          method: post
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.ApiKeyAuthorizerId}

  helper-execute-path-post:
    handler: cmd/handlers/helpers/main.go
    description: "Execute helper via API key (path auth, POST)"
    memorySize: 512
    timeout: 29
    environment:
      FUNCTION_NAME: helper-execute
      ENDPOINT_PATH: /helper/{api_key}/{identifier}
    events:
      - httpApi:
          path: /helper/{api_key}/{identifier}
          method: post
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.ApiKeyAuthorizerId}

  helper-execute-path-get:
    handler: cmd/handlers/helpers/main.go
    description: "Execute helper via API key (path auth, GET)"
    memorySize: 512
    timeout: 29
    environment:
      FUNCTION_NAME: helper-execute
      ENDPOINT_PATH: /helper/{api_key}/{identifier}
    events:
      - httpApi:
          path: /helper/{api_key}/{identifier}
          method: get
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.ApiKeyAuthorizerId}

