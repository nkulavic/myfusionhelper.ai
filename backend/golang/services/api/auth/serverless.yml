service: mfh-auth

frameworkVersion: '4'

plugins:
  - serverless-go-plugin

custom:
  appUrl:
    dev: https://dev.myfusionhelper.ai
    staging: https://staging.myfusionhelper.ai
    main: https://app.myfusionhelper.ai
  fromEmail:
    dev: noreply@dev.myfusionhelper.ai
    staging: noreply@staging.myfusionhelper.ai
    main: noreply@myfusionhelper.ai
  go:
    baseDir: ../../..
    supportedRuntimes: ["provided.al2023"]
    buildProvidedRuntimeAsBootstrap: true
    cmd: 'GOARCH=arm64 GOOS=linux go build -ldflags="-s -w"'

provider:
  name: aws
  runtime: provided.al2023
  architecture: arm64
  region: us-west-2
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 29
  tracing:
    lambda: true
    apiGateway: true
  httpApi:
    id: ${cf:mfh-api-gateway-${self:provider.stage}.HttpApiId}
  environment:
    SERVICE_VERSION: "2025.02.04.0001"
    STAGE: ${self:provider.stage}
    COGNITO_USER_POOL_ID: ${cf:mfh-infrastructure-cognito-${self:provider.stage}.CognitoUserPoolId}
    COGNITO_CLIENT_ID: ${cf:mfh-infrastructure-cognito-${self:provider.stage}.CognitoUserPoolClientId}
    COGNITO_CLIENT_SECRET: ""
    COGNITO_REGION: ${self:provider.region}
    COGNITO_JWKS_URI: ${cf:mfh-infrastructure-cognito-${self:provider.stage}.CognitoJwksUri}
    COGNITO_ISSUER: ${cf:mfh-infrastructure-cognito-${self:provider.stage}.CognitoIssuer}
    USERS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UsersTableName}
    ACCOUNTS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.AccountsTableName}
    USER_ACCOUNTS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UserAccountsTableName}
    DEFAULT_FROM_EMAIL: ${self:custom.fromEmail.${self:provider.stage}, 'noreply@myfusionhelper.ai'}
    DEFAULT_FROM_NAME: MyFusion Helper
    APP_URL: ${self:custom.appUrl.${self:provider.stage}, 'https://app.myfusionhelper.ai'}
    API_VERSION: v1
    API_REFERENCE: mfh-api
    INTERNAL_SECRETS_PARAM: /myfusionhelper/${self:provider.stage}/secrets
    NOTIFICATION_QUEUE_URL: ${cf:mfh-infrastructure-sqs-${self:provider.stage}.NotificationQueueUrl}
    EMAIL_VERIFICATIONS_TABLE: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.EmailVerificationsTableName}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
            - dynamodb:DescribeTable
          Resource:
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UsersTableArn}
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.AccountsTableArn}
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UserAccountsTableArn}
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UsersTableArn}/index/*"
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.AccountsTableArn}/index/*"
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.UserAccountsTableArn}/index/*"
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.EmailVerificationsTableArn}
            - "${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.EmailVerificationsTableArn}/index/*"
        - Effect: Allow
          Action:
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminDeleteUser
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminListGroupsForUser
            - cognito-idp:ListUsers
            - cognito-idp:InitiateAuth
            - cognito-idp:RespondToAuthChallenge
            - cognito-idp:GlobalSignOut
            - cognito-idp:AdminUserGlobalSignOut
            - cognito-idp:GetUser
            - cognito-idp:ChangePassword
            - cognito-idp:AssociateSoftwareToken
            - cognito-idp:VerifySoftwareToken
            - cognito-idp:AdminSetUserMFAPreference
            - cognito-idp:SetUserMFAPreference
            - cognito-idp:ConfirmSignUp
            - cognito-idp:ForgotPassword
            - cognito-idp:ConfirmForgotPassword
          Resource:
            - ${cf:mfh-infrastructure-cognito-${self:provider.stage}.CognitoUserPoolArn}
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "arn:aws:logs:${self:provider.region}:*:*"
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "arn:aws:ses:${self:provider.region}:*:identity/myfusionhelper.ai"
        - Effect: Allow
          Action:
            - sqs:SendMessage
          Resource:
            - ${cf:mfh-infrastructure-sqs-${self:provider.stage}.NotificationQueueArn}
        - Effect: Allow
          Action:
            - ssm:GetParameter
          Resource:
            - "arn:aws:ssm:${self:provider.region}:*:parameter/myfusionhelper/${self:provider.stage}/secrets"
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: "*"

functions:
  # Protected endpoints (require auth)
  auth-status:
    handler: cmd/handlers/auth/main.go
    description: "User status and authentication info"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-status
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-status
      ENDPOINT_PATH: /auth/status
    events:
      - httpApi:
          path: /auth/status
          method: get
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-profile:
    handler: cmd/handlers/auth/main.go
    description: "Update user profile"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-profile
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-profile
      ENDPOINT_PATH: /auth/profile
    events:
      - httpApi:
          path: /auth/profile
          method: put
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-onboarding-complete:
    handler: cmd/handlers/auth/main.go
    description: "Mark onboarding as complete"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-onboarding-complete
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-onboarding-complete
      ENDPOINT_PATH: /auth/onboarding-complete
    events:
      - httpApi:
          path: /auth/onboarding-complete
          method: patch
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-logout:
    handler: cmd/handlers/auth/main.go
    description: "Session logout and token revocation"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-logout
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-logout
      ENDPOINT_PATH: /auth/logout
    events:
      - httpApi:
          path: /auth/logout
          method: post
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-password:
    handler: cmd/handlers/auth/main.go
    description: "Change user password"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-password
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-password
      ENDPOINT_PATH: /auth/password
    events:
      - httpApi:
          path: /auth/password
          method: put
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-mfa-status:
    handler: cmd/handlers/auth/main.go
    description: "Get MFA status for user"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-mfa-status
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-mfa-status
      ENDPOINT_PATH: /auth/mfa/status
    events:
      - httpApi:
          path: /auth/mfa/status
          method: get
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-mfa-setup-totp:
    handler: cmd/handlers/auth/main.go
    description: "Initiate TOTP setup"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-mfa-setup-totp
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-mfa-setup-totp
      ENDPOINT_PATH: /auth/mfa/setup-totp
    events:
      - httpApi:
          path: /auth/mfa/setup-totp
          method: post
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-mfa-verify-totp:
    handler: cmd/handlers/auth/main.go
    description: "Verify TOTP code and enable MFA"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-mfa-verify-totp
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-mfa-verify-totp
      ENDPOINT_PATH: /auth/mfa/verify-totp
    events:
      - httpApi:
          path: /auth/mfa/verify-totp
          method: post
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-mfa-enable-sms:
    handler: cmd/handlers/auth/main.go
    description: "Enable SMS MFA"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-mfa-enable-sms
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-mfa-enable-sms
      ENDPOINT_PATH: /auth/mfa/enable-sms
    events:
      - httpApi:
          path: /auth/mfa/enable-sms
          method: post
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-mfa-disable:
    handler: cmd/handlers/auth/main.go
    description: "Disable MFA"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-mfa-disable
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-mfa-disable
      ENDPOINT_PATH: /auth/mfa/disable
    events:
      - httpApi:
          path: /auth/mfa/disable
          method: post
          authorizer:
            id: ${cf:mfh-api-gateway-${self:provider.stage}.CognitoAuthorizerId}

  auth-mfa-challenge:
    handler: cmd/handlers/auth/main.go
    description: "Submit MFA challenge code during login"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-mfa-challenge
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-mfa-challenge
      ENDPOINT_PATH: /auth/mfa-challenge
    events:
      - httpApi:
          path: /auth/mfa-challenge
          method: post

  auth-refresh:
    handler: cmd/handlers/auth/main.go
    description: "Token refresh"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-refresh
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-refresh
      ENDPOINT_PATH: /auth/refresh
    events:
      - httpApi:
          path: /auth/refresh
          method: post

  # Public endpoints (no auth required)
  auth-health:
    handler: cmd/handlers/auth/main.go
    description: "Health check endpoint"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-health
    memorySize: 128
    timeout: 5
    environment:
      FUNCTION_NAME: auth-health
      ENDPOINT_PATH: /auth/health
    events:
      - httpApi:
          path: /auth/health
          method: get

  auth-login:
    handler: cmd/handlers/auth/main.go
    description: "User authentication"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-login
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-login
      ENDPOINT_PATH: /auth/login
    events:
      - httpApi:
          path: /auth/login
          method: post

  auth-register:
    handler: cmd/handlers/auth/main.go
    description: "User registration"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-register
    memorySize: 256
    timeout: 10
    reservedConcurrency: 100
    environment:
      FUNCTION_NAME: auth-register
      ENDPOINT_PATH: /auth/register
    events:
      - httpApi:
          path: /auth/register
          method: post

  auth-forgot-password:
    handler: cmd/handlers/auth/main.go
    description: "Trigger password reset email"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-forgot-password
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-forgot-password
      ENDPOINT_PATH: /auth/forgot-password
    events:
      - httpApi:
          path: /auth/forgot-password
          method: post

  auth-reset-password:
    handler: cmd/handlers/auth/main.go
    description: "Confirm password reset with code"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-reset-password
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-reset-password
      ENDPOINT_PATH: /auth/reset-password
    events:
      - httpApi:
          path: /auth/reset-password
          method: post

  auth-verify-email:
    handler: cmd/handlers/auth/main.go
    description: "Verify email with 6-digit code"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-verify-email
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-verify-email
      ENDPOINT_PATH: /auth/verify-email
    events:
      - httpApi:
          path: /auth/verify-email
          method: post

  auth-resend-verification:
    handler: cmd/handlers/auth/main.go
    description: "Resend email verification code"
    tags:
      Service: ${self:service}
      Stage: ${self:provider.stage}
      Function: auth-resend-verification
    memorySize: 256
    timeout: 10
    environment:
      FUNCTION_NAME: auth-resend-verification
      ENDPOINT_PATH: /auth/resend-verification
    events:
      - httpApi:
          path: /auth/resend-verification
          method: post
