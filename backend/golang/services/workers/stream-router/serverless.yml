service: mfh-stream-router

provider:
  name: aws
  runtime: provided.al2023
  architecture: arm64
  region: us-west-2
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 60
  tracing:
    lambda: true
  environment:
    STAGE: ${self:provider.stage}
    # Fallback queue for passthrough mode during migration
    FALLBACK_QUEUE_URL: ${cf:mfh-infrastructure-sqs-${self:provider.stage}.HelperExecutionQueueUrl}

  iam:
    role:
      statements:
        # Allow sending messages to all SQS queues
        - Effect: Allow
          Action:
            - sqs:SendMessage
          Resource:
            - arn:aws:sqs:${aws:region}:${aws:accountId}:mfh-${self:provider.stage}-*-executions.fifo
            - ${cf:mfh-infrastructure-sqs-${self:provider.stage}.HelperExecutionQueueArn}
        # Allow reading from SSM Parameter Store for queue URL lookup
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource:
            - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/mfh/${self:provider.stage}/sqs/*
        # Allow reading from DynamoDB Stream
        - Effect: Allow
          Action:
            - dynamodb:DescribeStream
            - dynamodb:GetRecords
            - dynamodb:GetShardIterator
            - dynamodb:ListStreams
          Resource:
            - ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.ExecutionsTableStreamArn}

functions:
  router:
    handler: bootstrap
    events:
      - stream:
          type: dynamodb
          arn: ${cf:mfh-infrastructure-dynamodb-core-${self:provider.stage}.ExecutionsTableStreamArn}
          batchSize: 100
          startingPosition: LATEST
          maximumRetryAttempts: 3
          bisectBatchOnFunctionError: true
          functionResponseType: ReportBatchItemFailures

# Build manually with: cd ../../.. && GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o services/workers/stream-router/bootstrap ./services/workers/stream-router

# plugins:
#   - serverless-go-plugin

# custom:
#   go:
#     baseDir: ../../..
#     cmd: GOOS=linux GOARCH=arm64 go build -ldflags="-s -w"
#     supportedRuntimes: ["provided.al2023"]
#     buildProvidedRuntimeAsBootstrap: true
#     monorepo: false
